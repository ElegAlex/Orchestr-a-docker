import React, { useState, useEffect } from 'react';
import { useNavigate, useParams } from 'react-router-dom';
import { useForm, Controller } from 'react-hook-form';
import {
  Box,
  Card,
  CardContent,
  TextField,
  Button,
  Typography,
  MenuItem,
  Grid,
  IconButton,
  Alert,
  Skeleton,
} from '@mui/material';
import { ArrowBack, Save } from '@mui/icons-material';
import { projectService } from '../services/project.service';
import { ProjectStatus, Priority, ProjectCategory, Project } from '../types';

interface ProjectFormData {
  name: string;
  description: string;
  startDate: string;
  endDate: string;
  budget: number;
  status: ProjectStatus;
  priority: Priority;
  category: ProjectCategory;
  sponsor: string;
  projectManager: string;
}

export const ProjectEdit: React.FC = () => {
  const navigate = useNavigate();
  const { projectId } = useParams<{ projectId: string }>();
  const [loading, setLoading] = useState(false);
  const [fetchLoading, setFetchLoading] = useState(true);
  const [error, setError] = useState<string>('');
  const [project, setProject] = useState<Project | null>(null);
  
  const {
    control,
    handleSubmit,
    watch,
    reset,
    formState: { errors, isValid, isDirty },
  } = useForm<ProjectFormData>({
    mode: 'onChange',
    defaultValues: {
      name: '',
      description: '',
      startDate: '',
      endDate: '',
      budget: 0,
      status: 'draft',
      priority: 'P2',
      category: 'IT',
      sponsor: '',
      projectManager: '',
    },
  });

  const startDate = watch('startDate');

  useEffect(() => {
    if (projectId) {
      loadProject();
    }
  }, [projectId]);

  const loadProject = async () => {
    if (!projectId) return;
    
    setFetchLoading(true);
    setError('');
    
    try {
      const projectData = await projectService.getProject(projectId);
      if (projectData) {
        setProject(projectData);
        reset({
          name: projectData.name,
          description: projectData.description || '',
          startDate: projectData.startDate.toISOString().split('T')[0],
          endDate: projectData.dueDate ? projectData.dueDate.toISOString().split('T')[0] : '',
          budget: projectData.budget || 0,
          status: projectData.status,
          priority: projectData.priority,
          category: projectData.category,
          sponsor: projectData.sponsor || '',
          projectManager: projectData.projectManager || '',
        });
      } else {
        setError('Projet non trouvé');
      }
    } catch (err: any) {
      setError(err.message || 'Erreur lors du chargement du projet');
    } finally {
      setFetchLoading(false);
    }
  };

  const onSubmit = async (data: ProjectFormData) => {
    if (!projectId || !project) return;
    
    setLoading(true);
    setError('');

    try {
      await projectService.updateProject(projectId, {
        name: data.name,
        description: data.description,
        startDate: new Date(data.startDate),
        budget: data.budget,
        status: data.status,
        priority: data.priority,
        sponsor: data.sponsor,
        projectManager: data.projectManager,
        category: data.category,
        updatedAt: new Date(),
      });
      navigate(`/projects/${projectId}`);
    } catch (err: any) {
      setError(err.message || 'Erreur lors de la mise à jour du projet');
      setLoading(false);
    }
  };

  if (fetchLoading) {
    return (
      <Box sx={{ p: 3 }}>
        <Box sx={{ display: 'flex', alignItems: 'center', mb: 3 }}>
          <IconButton onClick={() => navigate('/projects')} sx={{ mr: 2 }}>
            <ArrowBack />
          </IconButton>
          <Skeleton variant="text" width={200} height={40} />
        </Box>
        <Card>
          <CardContent>
            <Grid container spacing={3}>
              {Array.from({ length: 8 }).map((_, index) => (
                <Grid item xs={12} sm={6} key={index}>
                  <Skeleton variant="rectangular" height={56} />
                </Grid>
              ))}
            </Grid>
          </CardContent>
        </Card>
      </Box>
    );
  }

  if (error && !project) {
    return (
      <Box sx={{ p: 3 }}>
        <Box sx={{ display: 'flex', alignItems: 'center', mb: 3 }}>
          <IconButton onClick={() => navigate('/projects')} sx={{ mr: 2 }}>
            <ArrowBack />
          </IconButton>
          <Typography variant="h4" component="h1">
            Erreur
          </Typography>
        </Box>
        <Alert severity="error">{error}</Alert>
      </Box>
    );
  }

  return (
    <Box sx={{ p: 3 }}>
      <Box sx={{ display: 'flex', alignItems: 'center', mb: 3 }}>
        <IconButton onClick={() => navigate(`/projects/${projectId}`)} sx={{ mr: 2 }}>
          <ArrowBack />
        </IconButton>
        <Typography variant="h4" component="h1">
          Modifier le projet : {project?.name}
        </Typography>
      </Box>

      <Card>
        <CardContent>
          <form onSubmit={handleSubmit(onSubmit)}>
            <Grid container spacing={3}>
              <Grid item xs={12}>
                <Controller
                  name="name"
                  control={control}
                  rules={{
                    required: 'Le nom du projet est requis',
                    minLength: {
                      value: 3,
                      message: 'Le nom doit contenir au moins 3 caractères'
                    },
                    maxLength: {
                      value: 100,
                      message: 'Le nom ne peut pas dépasser 100 caractères'
                    }
                  }}
                  render={({ field }) => (
                    <TextField
                      {...field}
                      fullWidth
                      label="Nom du projet"
                      autoFocus
                      error={!!errors.name}
                      helperText={errors.name?.message}
                    />
                  )}
                />
              </Grid>

              <Grid item xs={12}>
                <Controller
                  name="description"
                  control={control}
                  rules={{
                    required: 'La description est requise',
                    minLength: {
                      value: 10,
                      message: 'La description doit contenir au moins 10 caractères'
                    }
                  }}
                  render={({ field }) => (
                    <TextField
                      {...field}
                      fullWidth
                      label="Description"
                      multiline
                      rows={4}
                      error={!!errors.description}
                      helperText={errors.description?.message}
                    />
                  )}
                />
              </Grid>

              <Grid item xs={12} sm={6}>
                <Controller
                  name="startDate"
                  control={control}
                  rules={{
                    required: 'La date de début est requise',
                  }}
                  render={({ field }) => (
                    <TextField
                      {...field}
                      fullWidth
                      label="Date de début"
                      type="date"
                      InputLabelProps={{ shrink: true }}
                      error={!!errors.startDate}
                      helperText={errors.startDate?.message}
                    />
                  )}
                />
              </Grid>

              <Grid item xs={12} sm={6}>
                <Controller
                  name="endDate"
                  control={control}
                  rules={{
                    required: 'La date de fin est requise',
                    validate: (value) => {
                      if (new Date(value) <= new Date(startDate)) {
                        return 'La date de fin doit être postérieure à la date de début';
                      }
                      return true;
                    }
                  }}
                  render={({ field }) => (
                    <TextField
                      {...field}
                      fullWidth
                      label="Date de fin"
                      type="date"
                      InputLabelProps={{ shrink: true }}
                      error={!!errors.endDate}
                      helperText={errors.endDate?.message}
                    />
                  )}
                />
              </Grid>

              <Grid item xs={12} sm={6}>
                <Controller
                  name="budget"
                  control={control}
                  rules={{
                    required: 'Le budget est requis',
                    min: {
                      value: 0,
                      message: 'Le budget ne peut pas être négatif'
                    }
                  }}
                  render={({ field }) => (
                    <TextField
                      {...field}
                      fullWidth
                      label="Budget (€)"
                      type="number"
                      onChange={(e) => field.onChange(Number(e.target.value))}
                      error={!!errors.budget}
                      helperText={errors.budget?.message}
                    />
                  )}
                />
              </Grid>

              <Grid item xs={12} sm={6}>
                <Controller
                  name="category"
                  control={control}
                  rules={{
                    required: 'La catégorie est requise'
                  }}
                  render={({ field }) => (
                    <TextField
                      {...field}
                      fullWidth
                      select
                      label="Catégorie"
                      error={!!errors.category}
                      helperText={errors.category?.message}
                    >
                      <MenuItem value="IT">Informatique</MenuItem>
                      <MenuItem value="HR">Ressources Humaines</MenuItem>
                      <MenuItem value="Finance">Finance</MenuItem>
                      <MenuItem value="Compliance">Conformité</MenuItem>
                      <MenuItem value="Other">Autre</MenuItem>
                    </TextField>
                  )}
                />
              </Grid>

              <Grid item xs={12} sm={6}>
                <Controller
                  name="status"
                  control={control}
                  render={({ field }) => (
                    <TextField
                      {...field}
                      fullWidth
                      select
                      label="Statut"
                      error={!!errors.status}
                      helperText={errors.status?.message}
                    >
                      <MenuItem value="draft">Brouillon</MenuItem>
                      <MenuItem value="planning">Planification</MenuItem>
                      <MenuItem value="active">Actif</MenuItem>
                      <MenuItem value="on_hold">En pause</MenuItem>
                      <MenuItem value="completed">Terminé</MenuItem>
                      <MenuItem value="cancelled">Annulé</MenuItem>
                    </TextField>
                  )}
                />
              </Grid>

              <Grid item xs={12} sm={6}>
                <Controller
                  name="priority"
                  control={control}
                  render={({ field }) => (
                    <TextField
                      {...field}
                      fullWidth
                      select
                      label="Priorité"
                      error={!!errors.priority}
                      helperText={errors.priority?.message}
                    >
                      <MenuItem value="P0">P0 - Critique</MenuItem>
                      <MenuItem value="P1">P1 - Élevée</MenuItem>
                      <MenuItem value="P2">P2 - Moyenne</MenuItem>
                      <MenuItem value="P3">P3 - Faible</MenuItem>
                    </TextField>
                  )}
                />
              </Grid>

              <Grid item xs={12} sm={6}>
                <Controller
                  name="sponsor"
                  control={control}
                  rules={{
                    required: 'Le sponsor est requis'
                  }}
                  render={({ field }) => (
                    <TextField
                      {...field}
                      fullWidth
                      label="Sponsor du projet"
                      error={!!errors.sponsor}
                      helperText={errors.sponsor?.message}
                    />
                  )}
                />
              </Grid>

              <Grid item xs={12} sm={6}>
                <Controller
                  name="projectManager"
                  control={control}
                  rules={{
                    required: 'Le chef de projet est requis'
                  }}
                  render={({ field }) => (
                    <TextField
                      {...field}
                      fullWidth
                      label="Chef de projet"
                      error={!!errors.projectManager}
                      helperText={errors.projectManager?.message}
                    />
                  )}
                />
              </Grid>

              {error && (
                <Grid item xs={12}>
                  <Alert severity="error">{error}</Alert>
                </Grid>
              )}

              <Grid item xs={12}>
                <Box sx={{ display: 'flex', justifyContent: 'flex-end', gap: 2 }}>
                  <Button
                    variant="outlined"
                    onClick={() => navigate(`/projects/${projectId}`)}
                    disabled={loading}
                  >
                    Annuler
                  </Button>
                  <Button
                    type="submit"
                    variant="contained"
                    startIcon={<Save />}
                    disabled={loading || !isValid || !isDirty}
                  >
                    {loading ? 'Mise à jour...' : 'Mettre à jour'}
                  </Button>
                </Box>
              </Grid>
            </Grid>
          </form>
        </CardContent>
      </Card>
    </Box>
  );
};