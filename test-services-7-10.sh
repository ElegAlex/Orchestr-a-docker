#!/bin/bash

# ==========================================
# TEST SERVICES 7-10 - ORCHESTR'A
# ==========================================
# Teste les services Projects, Tasks, Users, Milestones
#
# Session 7: Projects
# Session 8: Tasks
# Session 9: Users
# Session 10: Milestones

set -e

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Configuration
API_URL="http://localhost:4000/api"
ADMIN_EMAIL="test.admin@orchestra.local"
ADMIN_PASSWORD="Admin1234"

# Compteurs
TOTAL_TESTS=0
PASSED_TESTS=0
FAILED_TESTS=0

# Token storage
TOKEN=""

# Function: Print header
print_header() {
  echo ""
  echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
  echo -e "${BLUE}  üß™ TEST SERVICES 7-10 - ORCHESTR'A${NC}"
  echo -e "${BLUE}  Sessions: Projects, Tasks, Users, Milestones${NC}"
  echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
  echo ""
}

# Function: Test result
test_result() {
  local service="$1"
  local operation="$2"
  local status="$3"
  local details="$4"

  TOTAL_TESTS=$((TOTAL_TESTS + 1))

  if [ "$status" = "pass" ]; then
    PASSED_TESTS=$((PASSED_TESTS + 1))
    echo -e "${GREEN}‚úÖ PASS${NC} - $service: $operation"
    [ -n "$details" ] && echo -e "${CYAN}   ‚Üí $details${NC}"
  else
    FAILED_TESTS=$((FAILED_TESTS + 1))
    echo -e "${RED}‚ùå FAIL${NC} - $service: $operation"
    [ -n "$details" ] && echo -e "${RED}   ‚Üí $details${NC}"
  fi
}

# Function: Section header
section() {
  echo ""
  echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
  echo -e "${YELLOW}  $1${NC}"
  echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
}

# Function: Login and get token
login() {
  section "üîê AUTHENTIFICATION"

  local response=$(curl -s -w "\n%{http_code}" "$API_URL/auth/login" \
    -H "Content-Type: application/json" \
    -d "{\"email\":\"$ADMIN_EMAIL\",\"password\":\"$ADMIN_PASSWORD\"}")

  local body=$(echo "$response" | head -n -1)
  local http_code=$(echo "$response" | tail -n 1)

  if [ "$http_code" = "200" ] || [ "$http_code" = "201" ]; then
    TOKEN=$(echo "$body" | jq -r '.access_token // .accessToken // empty')

    if [ -n "$TOKEN" ] && [ "$TOKEN" != "null" ]; then
      test_result "Auth" "Login" "pass" "Token obtenu"
      return 0
    else
      test_result "Auth" "Login" "fail" "Token non trouv√© dans la r√©ponse"
      return 1
    fi
  else
    test_result "Auth" "Login" "fail" "HTTP $http_code"
    return 1
  fi
}

# ==========================================
# SESSION 7: PROJECTS
# ==========================================
test_projects() {
  section "üìä SESSION 7 - SERVICE PROJECTS"

  # Test 1: GET /api/projects (liste)
  local response=$(curl -s -w "\n%{http_code}" "$API_URL/projects" \
    -H "Authorization: Bearer $TOKEN")

  local body=$(echo "$response" | head -n -1)
  local http_code=$(echo "$response" | tail -n 1)

  if [ "$http_code" = "200" ]; then
    local has_data=$(echo "$body" | jq -e '.data' &>/dev/null && echo "yes" || echo "no")
    if [ "$has_data" = "yes" ]; then
      local count=$(echo "$body" | jq '.data | length')
      test_result "Projects" "GET /api/projects" "pass" "$count projets trouv√©s"
    else
      test_result "Projects" "GET /api/projects" "pass" "R√©ponse re√ßue"
    fi
  else
    test_result "Projects" "GET /api/projects" "fail" "HTTP $http_code"
  fi

  # Test 2: POST /api/projects (cr√©ation)
  local create_data='{
    "name": "Test Project Session 7",
    "description": "Projet de test automatique",
    "startDate": "2025-01-01T00:00:00.000Z",
    "endDate": "2025-12-31T00:00:00.000Z",
    "status": "active"
  }'

  local response=$(curl -s -w "\n%{http_code}" "$API_URL/projects" \
    -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/json" \
    -d "$create_data")

  local body=$(echo "$response" | head -n -1)
  local http_code=$(echo "$response" | tail -n 1)

  if [ "$http_code" = "200" ] || [ "$http_code" = "201" ]; then
    PROJECT_ID=$(echo "$body" | jq -r '.id')
    if [ -n "$PROJECT_ID" ] && [ "$PROJECT_ID" != "null" ]; then
      test_result "Projects" "POST /api/projects" "pass" "Projet cr√©√© (ID: ${PROJECT_ID:0:8}...)"
    else
      test_result "Projects" "POST /api/projects" "pass" "Projet cr√©√©"
    fi
  else
    test_result "Projects" "POST /api/projects" "fail" "HTTP $http_code - $(echo "$body" | jq -r '.message // empty')"
    PROJECT_ID=""
  fi

  # Test 3: GET /api/projects/:id (d√©tails)
  if [ -n "$PROJECT_ID" ]; then
    local response=$(curl -s -w "\n%{http_code}" "$API_URL/projects/$PROJECT_ID" \
      -H "Authorization: Bearer $TOKEN")

    local body=$(echo "$response" | head -n -1)
    local http_code=$(echo "$response" | tail -n 1)

    if [ "$http_code" = "200" ]; then
      local name=$(echo "$body" | jq -r '.name // empty')
      test_result "Projects" "GET /api/projects/:id" "pass" "Nom: $name"
    else
      test_result "Projects" "GET /api/projects/:id" "fail" "HTTP $http_code"
    fi
  else
    test_result "Projects" "GET /api/projects/:id" "fail" "Pas de PROJECT_ID"
  fi

  # Test 4: PUT/PATCH /api/projects/:id (update)
  if [ -n "$PROJECT_ID" ]; then
    local update_data='{
      "description": "Description mise √† jour par test automatique"
    }'

    local response=$(curl -s -w "\n%{http_code}" -X PATCH "$API_URL/projects/$PROJECT_ID" \
      -H "Authorization: Bearer $TOKEN" \
      -H "Content-Type: application/json" \
      -d "$update_data")

    local http_code=$(echo "$response" | tail -n 1)

    if [ "$http_code" = "200" ]; then
      test_result "Projects" "PATCH /api/projects/:id" "pass" "Projet mis √† jour"
    else
      test_result "Projects" "PATCH /api/projects/:id" "fail" "HTTP $http_code"
    fi
  fi

  # Test 5: DELETE /api/projects/:id
  if [ -n "$PROJECT_ID" ]; then
    local response=$(curl -s -w "\n%{http_code}" -X DELETE "$API_URL/projects/$PROJECT_ID" \
      -H "Authorization: Bearer $TOKEN")

    local http_code=$(echo "$response" | tail -n 1)

    if [ "$http_code" = "200" ] || [ "$http_code" = "204" ]; then
      test_result "Projects" "DELETE /api/projects/:id" "pass" "Projet supprim√©"
    else
      test_result "Projects" "DELETE /api/projects/:id" "fail" "HTTP $http_code"
    fi
  fi
}

# ==========================================
# SESSION 8: TASKS
# ==========================================
test_tasks() {
  section "üìã SESSION 8 - SERVICE TASKS"

  # Test 1: GET /api/tasks
  local response=$(curl -s -w "\n%{http_code}" "$API_URL/tasks" \
    -H "Authorization: Bearer $TOKEN")

  local body=$(echo "$response" | head -n -1)
  local http_code=$(echo "$response" | tail -n 1)

  if [ "$http_code" = "200" ]; then
    local has_data=$(echo "$body" | jq -e '.data' &>/dev/null && echo "yes" || echo "no")
    if [ "$has_data" = "yes" ]; then
      local count=$(echo "$body" | jq '.data | length')
      test_result "Tasks" "GET /api/tasks" "pass" "$count t√¢ches trouv√©es"
    else
      test_result "Tasks" "GET /api/tasks" "pass" "R√©ponse re√ßue"
    fi
  else
    test_result "Tasks" "GET /api/tasks" "fail" "HTTP $http_code"
  fi

  # Test 2: POST /api/tasks (n√©cessite un projectId valide)
  # On va cr√©er un projet temporaire d'abord
  local project_data='{
    "name": "Projet pour test tasks",
    "startDate": "2025-01-01T00:00:00.000Z",
    "endDate": "2025-12-31T00:00:00.000Z"
  }'

  local proj_response=$(curl -s "$API_URL/projects" \
    -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/json" \
    -d "$project_data")

  local TEMP_PROJECT_ID=$(echo "$proj_response" | jq -r '.id // empty')

  if [ -n "$TEMP_PROJECT_ID" ] && [ "$TEMP_PROJECT_ID" != "null" ]; then
    local task_data="{
      \"title\": \"Test Task Session 8\",
      \"description\": \"T√¢che de test automatique\",
      \"status\": \"todo\",
      \"priority\": \"medium\",
      \"projectId\": \"$TEMP_PROJECT_ID\"
    }"

    local response=$(curl -s -w "\n%{http_code}" "$API_URL/tasks" \
      -H "Authorization: Bearer $TOKEN" \
      -H "Content-Type: application/json" \
      -d "$task_data")

    local body=$(echo "$response" | head -n -1)
    local http_code=$(echo "$response" | tail -n 1)

    if [ "$http_code" = "200" ] || [ "$http_code" = "201" ]; then
      TASK_ID=$(echo "$body" | jq -r '.id')
      test_result "Tasks" "POST /api/tasks" "pass" "T√¢che cr√©√©e (ID: ${TASK_ID:0:8}...)"
    else
      test_result "Tasks" "POST /api/tasks" "fail" "HTTP $http_code - $(echo "$body" | jq -r '.message // empty')"
      TASK_ID=""
    fi
  else
    test_result "Tasks" "POST /api/tasks" "fail" "Impossible de cr√©er projet temporaire"
    TASK_ID=""
  fi

  # Test 3: GET /api/tasks/:id
  if [ -n "$TASK_ID" ]; then
    local response=$(curl -s -w "\n%{http_code}" "$API_URL/tasks/$TASK_ID" \
      -H "Authorization: Bearer $TOKEN")

    local body=$(echo "$response" | head -n -1)
    local http_code=$(echo "$response" | tail -n 1)

    if [ "$http_code" = "200" ]; then
      local title=$(echo "$body" | jq -r '.title // empty')
      test_result "Tasks" "GET /api/tasks/:id" "pass" "Titre: $title"
    else
      test_result "Tasks" "GET /api/tasks/:id" "fail" "HTTP $http_code"
    fi
  fi

  # Test 4: PATCH /api/tasks/:id
  if [ -n "$TASK_ID" ]; then
    local update_data='{
      "status": "in_progress"
    }'

    local response=$(curl -s -w "\n%{http_code}" -X PATCH "$API_URL/tasks/$TASK_ID" \
      -H "Authorization: Bearer $TOKEN" \
      -H "Content-Type: application/json" \
      -d "$update_data")

    local http_code=$(echo "$response" | tail -n 1)

    if [ "$http_code" = "200" ]; then
      test_result "Tasks" "PATCH /api/tasks/:id" "pass" "T√¢che mise √† jour"
    else
      test_result "Tasks" "PATCH /api/tasks/:id" "fail" "HTTP $http_code"
    fi
  fi

  # Cleanup: supprimer la t√¢che et le projet
  if [ -n "$TASK_ID" ]; then
    curl -s -X DELETE "$API_URL/tasks/$TASK_ID" \
      -H "Authorization: Bearer $TOKEN" &>/dev/null
  fi

  if [ -n "$TEMP_PROJECT_ID" ]; then
    curl -s -X DELETE "$API_URL/projects/$TEMP_PROJECT_ID" \
      -H "Authorization: Bearer $TOKEN" &>/dev/null
  fi
}

# ==========================================
# SESSION 9: USERS
# ==========================================
test_users() {
  section "üë§ SESSION 9 - SERVICE USERS"

  # Test 1: GET /api/users
  local response=$(curl -s -w "\n%{http_code}" "$API_URL/users" \
    -H "Authorization: Bearer $TOKEN")

  local body=$(echo "$response" | head -n -1)
  local http_code=$(echo "$response" | tail -n 1)

  if [ "$http_code" = "200" ]; then
    local has_data=$(echo "$body" | jq -e '.data' &>/dev/null && echo "yes" || echo "no")
    if [ "$has_data" = "yes" ]; then
      local count=$(echo "$body" | jq '.data | length')
      test_result "Users" "GET /api/users" "pass" "$count utilisateurs trouv√©s"
    else
      # Peut-√™tre un array direct
      local count=$(echo "$body" | jq 'length // 0')
      test_result "Users" "GET /api/users" "pass" "$count utilisateurs trouv√©s"
    fi
  else
    test_result "Users" "GET /api/users" "fail" "HTTP $http_code"
  fi

  # Test 2: POST /api/users (cr√©ation)
  local user_data='{
    "email": "test.session9.'$RANDOM'@orchestra.local",
    "password": "Test1234!",
    "firstName": "Test",
    "lastName": "Session9",
    "role": "team_member"
  }'

  local response=$(curl -s -w "\n%{http_code}" "$API_URL/users" \
    -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/json" \
    -d "$user_data")

  local body=$(echo "$response" | head -n -1)
  local http_code=$(echo "$response" | tail -n 1)

  if [ "$http_code" = "200" ] || [ "$http_code" = "201" ]; then
    USER_ID=$(echo "$body" | jq -r '.id')
    if [ -n "$USER_ID" ] && [ "$USER_ID" != "null" ]; then
      test_result "Users" "POST /api/users" "pass" "Utilisateur cr√©√© (ID: ${USER_ID:0:8}...)"
    else
      test_result "Users" "POST /api/users" "pass" "Utilisateur cr√©√©"
    fi
  else
    test_result "Users" "POST /api/users" "fail" "HTTP $http_code - $(echo "$body" | jq -r '.message // empty')"
    USER_ID=""
  fi

  # Test 3: GET /api/users/:id
  if [ -n "$USER_ID" ]; then
    local response=$(curl -s -w "\n%{http_code}" "$API_URL/users/$USER_ID" \
      -H "Authorization: Bearer $TOKEN")

    local body=$(echo "$response" | head -n -1)
    local http_code=$(echo "$response" | tail -n 1)

    if [ "$http_code" = "200" ]; then
      local email=$(echo "$body" | jq -r '.email // empty')
      test_result "Users" "GET /api/users/:id" "pass" "Email: $email"
    else
      test_result "Users" "GET /api/users/:id" "fail" "HTTP $http_code"
    fi
  fi

  # Test 4: PATCH /api/users/:id
  if [ -n "$USER_ID" ]; then
    local update_data='{
      "firstName": "TestUpdated"
    }'

    local response=$(curl -s -w "\n%{http_code}" -X PATCH "$API_URL/users/$USER_ID" \
      -H "Authorization: Bearer $TOKEN" \
      -H "Content-Type: application/json" \
      -d "$update_data")

    local http_code=$(echo "$response" | tail -n 1)

    if [ "$http_code" = "200" ]; then
      test_result "Users" "PATCH /api/users/:id" "pass" "Utilisateur mis √† jour"
    else
      test_result "Users" "PATCH /api/users/:id" "fail" "HTTP $http_code"
    fi
  fi

  # Test 5: DELETE /api/users/:id
  if [ -n "$USER_ID" ]; then
    local response=$(curl -s -w "\n%{http_code}" -X DELETE "$API_URL/users/$USER_ID" \
      -H "Authorization: Bearer $TOKEN")

    local http_code=$(echo "$response" | tail -n 1)

    if [ "$http_code" = "200" ] || [ "$http_code" = "204" ]; then
      test_result "Users" "DELETE /api/users/:id" "pass" "Utilisateur supprim√©"
    else
      test_result "Users" "DELETE /api/users/:id" "fail" "HTTP $http_code"
    fi
  fi
}

# ==========================================
# SESSION 10: MILESTONES
# ==========================================
test_milestones() {
  section "üéØ SESSION 10 - SERVICE MILESTONES"

  # Test 1: GET /api/milestones
  local response=$(curl -s -w "\n%{http_code}" "$API_URL/milestones" \
    -H "Authorization: Bearer $TOKEN")

  local body=$(echo "$response" | head -n -1)
  local http_code=$(echo "$response" | tail -n 1)

  if [ "$http_code" = "200" ]; then
    local has_data=$(echo "$body" | jq -e '.data' &>/dev/null && echo "yes" || echo "no")
    if [ "$has_data" = "yes" ]; then
      local count=$(echo "$body" | jq '.data | length')
      test_result "Milestones" "GET /api/milestones" "pass" "$count jalons trouv√©s"
    else
      test_result "Milestones" "GET /api/milestones" "pass" "R√©ponse re√ßue"
    fi
  else
    test_result "Milestones" "GET /api/milestones" "fail" "HTTP $http_code"
  fi

  # Test 2: POST /api/milestones (n√©cessite un projectId)
  local project_data='{
    "name": "Projet pour test milestones",
    "startDate": "2025-01-01T00:00:00.000Z",
    "endDate": "2025-12-31T00:00:00.000Z"
  }'

  local proj_response=$(curl -s "$API_URL/projects" \
    -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/json" \
    -d "$project_data")

  local TEMP_PROJECT_ID=$(echo "$proj_response" | jq -r '.id // empty')

  if [ -n "$TEMP_PROJECT_ID" ] && [ "$TEMP_PROJECT_ID" != "null" ]; then
    local milestone_data="{
      \"name\": \"Test Milestone Session 10\",
      \"description\": \"Jalon de test automatique\",
      \"dueDate\": \"2025-06-30T00:00:00.000Z\",
      \"status\": \"pending\",
      \"projectId\": \"$TEMP_PROJECT_ID\"
    }"

    local response=$(curl -s -w "\n%{http_code}" "$API_URL/milestones" \
      -H "Authorization: Bearer $TOKEN" \
      -H "Content-Type: application/json" \
      -d "$milestone_data")

    local body=$(echo "$response" | head -n -1)
    local http_code=$(echo "$response" | tail -n 1)

    if [ "$http_code" = "200" ] || [ "$http_code" = "201" ]; then
      MILESTONE_ID=$(echo "$body" | jq -r '.id')
      test_result "Milestones" "POST /api/milestones" "pass" "Jalon cr√©√© (ID: ${MILESTONE_ID:0:8}...)"
    else
      test_result "Milestones" "POST /api/milestones" "fail" "HTTP $http_code - $(echo "$body" | jq -r '.message // empty')"
      MILESTONE_ID=""
    fi
  else
    test_result "Milestones" "POST /api/milestones" "fail" "Impossible de cr√©er projet temporaire"
    MILESTONE_ID=""
  fi

  # Test 3: GET /api/milestones/:id
  if [ -n "$MILESTONE_ID" ]; then
    local response=$(curl -s -w "\n%{http_code}" "$API_URL/milestones/$MILESTONE_ID" \
      -H "Authorization: Bearer $TOKEN")

    local body=$(echo "$response" | head -n -1)
    local http_code=$(echo "$response" | tail -n 1)

    if [ "$http_code" = "200" ]; then
      local name=$(echo "$body" | jq -r '.name // empty')
      test_result "Milestones" "GET /api/milestones/:id" "pass" "Nom: $name"
    else
      test_result "Milestones" "GET /api/milestones/:id" "fail" "HTTP $http_code"
    fi
  fi

  # Test 4: PATCH /api/milestones/:id
  if [ -n "$MILESTONE_ID" ]; then
    local update_data='{
      "status": "completed"
    }'

    local response=$(curl -s -w "\n%{http_code}" -X PATCH "$API_URL/milestones/$MILESTONE_ID" \
      -H "Authorization: Bearer $TOKEN" \
      -H "Content-Type: application/json" \
      -d "$update_data")

    local http_code=$(echo "$response" | tail -n 1)

    if [ "$http_code" = "200" ]; then
      test_result "Milestones" "PATCH /api/milestones/:id" "pass" "Jalon mis √† jour"
    else
      test_result "Milestones" "PATCH /api/milestones/:id" "fail" "HTTP $http_code"
    fi
  fi

  # Cleanup
  if [ -n "$MILESTONE_ID" ]; then
    curl -s -X DELETE "$API_URL/milestones/$MILESTONE_ID" \
      -H "Authorization: Bearer $TOKEN" &>/dev/null
  fi

  if [ -n "$TEMP_PROJECT_ID" ]; then
    curl -s -X DELETE "$API_URL/projects/$TEMP_PROJECT_ID" \
      -H "Authorization: Bearer $TOKEN" &>/dev/null
  fi
}

# ==========================================
# MAIN EXECUTION
# ==========================================

print_header

# Login
if ! login; then
  echo ""
  echo -e "${RED}‚ùå Impossible de se connecter. V√©rifier que Docker est d√©marr√©.${NC}"
  echo ""
  exit 1
fi

# Run tests
test_projects
test_tasks
test_users
test_milestones

# ==========================================
# SUMMARY
# ==========================================

echo ""
echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${BLUE}  üìä R√âSULTATS SESSIONS 7-10${NC}"
echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""
echo "   Total Tests : $TOTAL_TESTS"
echo -e "   ${GREEN}Passed      : $PASSED_TESTS${NC}"
echo -e "   ${RED}Failed      : $FAILED_TESTS${NC}"
echo ""

if [ $FAILED_TESTS -eq 0 ]; then
  echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
  echo -e "${GREEN}  ‚úÖ TOUS LES TESTS PASSENT !${NC}"
  echo -e "${GREEN}  Services 7-10 op√©rationnels.${NC}"
  echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
  echo ""
  exit 0
else
  PASS_PERCENT=$((PASSED_TESTS * 100 / TOTAL_TESTS))

  if [ $PASS_PERCENT -ge 80 ]; then
    echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${YELLOW}  ‚ö†Ô∏è  TESTS PARTIELLEMENT R√âUSSIS ($PASS_PERCENT%)${NC}"
    echo -e "${YELLOW}  Quelques fonctionnalit√©s √† v√©rifier.${NC}"
    echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
  else
    echo -e "${RED}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${RED}  ‚ùå TESTS √âCHOU√âS ($PASS_PERCENT%)${NC}"
    echo -e "${RED}  Services n√©cessitent des corrections.${NC}"
    echo -e "${RED}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
  fi

  echo ""
  echo "üí° Aide:"
  echo "   - Logs backend: docker compose -f docker-compose.full.yml logs -f backend"
  echo "   - API Swagger: http://localhost:4000/api/docs"
  echo ""
  exit 1
fi
